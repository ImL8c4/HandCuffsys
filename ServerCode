local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerScriptService = game:GetService("ServerScriptService")
local HTTPService = game:GetService("HttpService")

local uxpRP = ReplicatedStorage.uxpRS
local uxpSSS = ServerScriptService.uxpSSS
local GlobalEvents = uxpRP.GlobalEvents
local RPHandcuffs = uxpRP.HandcuffsSystem
local SSHandcuffs = uxpSSS.HandcuffsSystem
local Untils = RPHandcuffs.Utils

local Settings = require(RPHandcuffs.Settings)
local ServerSettings = require(SSHandcuffs.ServerSettings)

local Manager = require(uxpSSS.ProfileService.Manager)

-- Importa il modulo WantedSystem
local WantedSystem = require(uxpRP.WantedSystem.Settings)

-- Tabella per tenere traccia di quale ufficiale ha arrestato quale criminale
local ArrestConnections = {}
-- Tabella per tenere traccia di quale criminale è seduto su quale sedile
local SeatConnections = {}
-- Tabella per tenere traccia dei giocatori ricercati
local WantedPlayers = {}

-- Valori predefiniti per l'arresto
local DEFAULT_ARREST_TIME = 120
local DEFAULT_ARREST_REASON = "Hai commesso atti illegali"

local function checkPlayer(Target)
	return Players:FindFirstChild(Target.Name)
end

-- Funzione per ottenere il livello di ricercato di un giocatore
local function getPlayerWantedLevel(player)
	if WantedPlayers[player.Name] then
		return WantedPlayers[player.Name].level
	end
	return 0
end

-- Funzione per ottenere il tempo di carcere in base al livello di ricercato
local function getJailTimeFromWantedLevel(level)
	local roundedLevel = math.floor(level * 2) / 2  -- Arrotonda a 0.5 più vicino
	return WantedSystem.JailTimes[roundedLevel] or DEFAULT_ARREST_TIME  -- Default a 120 secondi se non trovato
end
-- Funzione per ottenere il tempo di carcere in base al livello di ricercato
local function getJailTimeFromWantedLevel(level)
	local roundedLevel = math.floor(level * 2) / 2  -- Arrotonda a 0.5 più vicino
	return WantedSystem.JailTimes[roundedLevel] or DEFAULT_ARREST_TIME  -- Default a 120 secondi se non trovato
end

-- Funzione per generare un ID univoco per un sedile
local function getSeatId(seat)
	-- Crea un ID basato sul percorso completo del sedile nel workspace
	local path = seat:GetFullName()
	return path
end

-- Rilascia il prigioniero se l'ufficiale esce
local function playerLeaving(player)
	-- Controlla se questo giocatore ha arrestato qualcuno
	if ArrestConnections[player.Name] then
		for criminalName, _ in pairs(ArrestConnections[player.Name]) do
			local criminal = Players:FindFirstChild(criminalName)
			if criminal then
				if criminal.Character and criminal.Character:FindFirstChild("CuffedValue") then
					criminal.Character.CuffedValue.Value = false
					criminal.Character.GrabbedValue.Value = false
					criminal.Character.Humanoid.WalkSpeed = 16
					criminal.Character.Humanoid.JumpHeight = 7.2

					-- Restituisci gli oggetti al criminale
					for _, v in pairs(criminal.PlayerTools:GetChildren()) do
						if v:IsA("Tool") then
							v.Parent = criminal.Backpack
						end
					end

					-- Notifica al criminale che è stato rilasciato
					GlobalEvents.RemoteEvent:FireClient(criminal, "Notification", "Sei stato rilasciato perché l'ufficiale ha lasciato il gioco.")
				end
			end
		end

		-- Pulisci le connessioni
		ArrestConnections[player.Name] = nil
	end

	-- Controlla anche se qualche criminale è seduto in un veicolo
	for seatId, criminalInfo in pairs(SeatConnections) do
		if criminalInfo.officer == player.Name then
			local criminal = Players:FindFirstChild(criminalInfo.criminal)
			if criminal and criminal.Character then
				criminal.Character.Humanoid.Sit = false
				GlobalEvents.RemoteEvent:FireClient(criminal, "Notification", "Sei stato rilasciato dal veicolo perché l'ufficiale ha lasciato il gioco.")
			end
			SeatConnections[seatId] = nil
		end
	end
end

-- Connettiti a PlayerRemoving per gestire l'uscita dell'ufficiale
Players.PlayerRemoving:Connect(playerLeaving)

-- Funzione per creare prompt per un sedile
local function createSeatPrompt(seat)
	-- Controlla se il sedile ha già un prompt
	if seat:FindFirstChild("PrisonerSeatPrompt") or seat:FindFirstChild("SeatPrompt") then
		return
	end

	-- Crea due tipi di prompt: uno per poliziotti e uno per tutti gli altri
	-- Prompt per poliziotti
	local officerPrompt = Instance.new("ProximityPrompt")
	officerPrompt.Name = "PrisonerSeatPrompt"
	officerPrompt.ActionText = "Metti Criminale"
	officerPrompt.ObjectText = "Sedile"
	officerPrompt.KeyboardKeyCode = Enum.KeyCode.E
	officerPrompt.MaxActivationDistance = 10
	officerPrompt.RequiresLineOfSight = false
	officerPrompt.Parent = seat

	-- Prompt per tutti gli altri giocatori
	local playerPrompt = Instance.new("ProximityPrompt")
	playerPrompt.Name = "SeatPrompt"
	playerPrompt.ActionText = "Mettiti seduto"
	playerPrompt.ObjectText = "Sedile"
	playerPrompt.KeyboardKeyCode = Enum.KeyCode.E
	playerPrompt.MaxActivationDistance = 10
	playerPrompt.RequiresLineOfSight = false
	playerPrompt.Parent = seat

	-- Script per gestire l'occupazione del sedile
	local script = Instance.new("Script")
	script.Name = "SeatOccupancyHandler"
	script.Parent = seat
	script.Source = [[local proximityPrompt = script.Parent:FindFirstChild("SeatPrompt")
local seat = script.Parent
seat:GetPropertyChangedSignal("Occupant"):Connect(function()
    if seat.Occupant then
        if proximityPrompt then proximityPrompt.Enabled = false end
        if script.Parent:FindFirstChild("PrisonerSeatPrompt") then
            script.Parent.PrisonerSeatPrompt.Enabled = false
        end
    else
        if proximityPrompt then proximityPrompt.Enabled = true end
        if script.Parent:FindFirstChild("PrisonerSeatPrompt") then
            script.Parent.PrisonerSeatPrompt.Enabled = true
        end
    end
end)

if proximityPrompt then
    proximityPrompt.Triggered:Connect(function(player)
        seat:Sit(player.Character.Humanoid)
    end)
end]]

	-- Gestione del prompt per poliziotti
	officerPrompt.Triggered:Connect(function(player)
		-- Controlla se il giocatore ha un criminale ammanettato
		if player.Character and player.Character:FindFirstChild("TargetObject") and player.Character.TargetObject.Value then
			local criminal = player.Character.TargetObject.Value
			if criminal.Character and criminal.Character:FindFirstChild("CuffedValue") and criminal.Character.CuffedValue.Value then
				-- Controlla se l'ufficiale è quello che ha ammanettato il criminale
				if ArrestConnections[player.Name] and ArrestConnections[player.Name][criminal.Name] then
					-- Controlla se il sedile è già occupato
					if seat.Occupant then
						GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Questo sedile è già occupato.")
						return
					end

					local seatId = getSeatId(seat)
					if not SeatConnections[seatId] then
						-- Rilascia la presa sul criminale prima di metterlo sul sedile
						criminal.Character.GrabbedValue.Value = false

						-- Teleporta il criminale vicino al sedile per facilitare l'azione
						criminal.Character:SetPrimaryPartCFrame(seat.CFrame * CFrame.new(0, 2, 0))

						-- Metti il criminale sul sedile direttamente
						seat:Sit(criminal.Character.Humanoid)

						-- Attendi un momento per assicurarsi che il sedile sia stato occupato
						task.wait(0.2)

						-- Verifica che il criminale sia effettivamente seduto
						if seat.Occupant == criminal.Character.Humanoid then
							-- Registra la connessione sedile-criminale
							SeatConnections[seatId] = {
								criminal = criminal.Name,
								officer = player.Name
							}

							-- Notifica al criminale che è stato messo nel veicolo
							GlobalEvents.RemoteEvent:FireClient(criminal, "Notification", "Sei stato messo in un veicolo.")
							-- Notifica anche all'ufficiale
							GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Hai messo il prigioniero nel veicolo.")
						else
							GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non è stato possibile mettere il criminale nel sedile.")
						end
					else
						GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Questo sedile è già assegnato a un prigioniero.")
					end
				else
					GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi mettere questo giocatore in un veicolo perché non l'hai ammanettato tu.")
				end
			else
				GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non hai un prigioniero da mettere nel veicolo.")
			end
		else
			GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non hai un prigioniero da mettere nel veicolo.")
		end
	end)
end

local function createAllSeatPrompts()
	for _, seat in pairs(workspace:GetDescendants()) do
		if seat:IsA("Seat") or seat:IsA("VehicleSeat") then
			createSeatPrompt(seat)
		end
	end
end

-- Crea i prompt per tutti i sedili esistenti
task.spawn(function()
	wait(5) -- Attendi che il gioco si carichi completamente
	createAllSeatPrompts()
end)

-- Connettiti all'evento DescendantAdded del workspace per aggiungere prompt ai nuovi sedili
workspace.DescendantAdded:Connect(function(descendant)
	if descendant:IsA("Seat") or descendant:IsA("VehicleSeat") then
		task.wait(1) -- Attendi un momento per assicurarsi che il sedile sia completamente caricato
		createSeatPrompt(descendant)
	end
end)

-- Funzione per aggiornare l'UI del giocatore per mostrare il suo stato di ricercato
local function updatePlayerWantedUI(player)
	if WantedPlayers[player.Name] then
		-- Invia l'informazione sul livello di ricercato al client
		GlobalEvents.RemoteEvent:FireClient(player, "UpdateWantedLevel", WantedPlayers[player.Name].level)
	else
		-- Rimuovi qualsiasi indicazione di ricercato
		GlobalEvents.RemoteEvent:FireClient(player, "UpdateWantedLevel", 0)
	end
end

-- Funzione per rimuovere un criminale da un sedile
local function removeFromSeat(criminal)
	for seatId, criminalInfo in pairs(SeatConnections) do
		if criminalInfo.criminal == criminal.Name then
			-- Trova il sedile nel workspace basandosi sull'ID
			local seatParts = seatId:split(".")
			local seatName = seatParts[#seatParts]

			-- Cerca il sedile nel workspace (questa è una ricerca semplificata)
			for _, seat in pairs(workspace:GetDescendants()) do
				if (seat:IsA("Seat") or seat:IsA("VehicleSeat")) and getSeatId(seat) == seatId then
					if seat.Occupant == criminal.Character.Humanoid then
						criminal.Character.Humanoid.Sit = false
					end
					break
				end
			end

			SeatConnections[seatId] = nil
			return true
		end
	end
	return false
end

-- Funzione per creare prompt nelle celle
local function createJailCellPrompts()
	for _, jailCell in pairs(workspace:GetDescendants()) do
		if jailCell.Name == "JailCell" and jailCell:IsA("BasePart") then
			-- Controlla se la cella ha già un prompt
			if jailCell:FindFirstChild("ArrestPrompt") then
				continue
			end

			local prompt = Instance.new("ProximityPrompt")
			prompt.Name = "ArrestPrompt"
			prompt.ActionText = "Arresta Criminale"
			prompt.ObjectText = "Cella"
			prompt.KeyboardKeyCode = Enum.KeyCode.E
			prompt.MaxActivationDistance = 10
			prompt.RequiresLineOfSight = false
			prompt.Parent = jailCell

			prompt.Triggered:Connect(function(player)
				-- Controlla se il giocatore ha un criminale ammanettato
				if player.Character and player.Character:FindFirstChild("TargetObject") and player.Character.TargetObject.Value then
					local criminal = player.Character.TargetObject.Value
					if criminal.Character and criminal.Character:FindFirstChild("CuffedValue") and criminal.Character.CuffedValue.Value then
						-- Solo l'ufficiale che ha ammanettato il giocatore può arrestarlo
						if ArrestConnections[player.Name] and ArrestConnections[player.Name][criminal.Name] then
							-- Verifica se il criminale è ricercato
							local wantedLevel = getPlayerWantedLevel(criminal)
							if wantedLevel <= 0 then
								GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi arrestare questo giocatore perché non è ricercato.")
								return
							end

							-- Corretto: Gestisci direttamente l'arresto qui senza chiamare FireServer
							-- Inizia il processo di arresto
							for i, v in pairs(Settings.CanHandcuffPlayers) do
								if i == player.Team then
									for i1, v1 in pairs(v) do
										if i1 == criminal.Team then
											if v1.CanArrestPlayer and v1.CanSendPlayerToJail then
												local Profile = Manager.Profiles[criminal]

												-- Determina il tempo di arresto in base al livello di ricercato
												local arrestTime = getJailTimeFromWantedLevel(wantedLevel)
												local arrestReason = "Ricercato (Stellette: " .. wantedLevel .. ")"
												if WantedPlayers[criminal.Name] and #WantedPlayers[criminal.Name].reason > 0 then
													arrestReason = arrestReason .. ": " .. table.concat(WantedPlayers[criminal.Name].reason, ", ")
												end

												Profile.Data.HandcuffsSystem.Reason = arrestReason
												Profile.Data.HandcuffsSystem.ArrestTime = arrestTime + os.time()
												Profile.Data.HandcuffsSystem.OfficerName = player.Name

												criminal.Team = v1.JailedTeam
												criminal.JailedValue.Value = arrestTime + os.time()

												criminal.Character.CuffedValue.Value = false
												criminal.Character.GrabbedValue.Value = false

												for _, item in pairs(criminal.PlayerTools:GetChildren()) do
													item:Destroy()
												end

												GlobalEvents.RemoteEvent:FireClient(criminal, "CuffPlayer", DEFAULT_ARREST_REASON, player.Name)

												if ServerSettings.WebhookEnabled then
													local profileUrl = "https://thumbnails.roproxy.com/v1/users/avatar-bust?userIds=".. player.UserId .."&size=420x420&format=Png&isCircular=false"

													local response = HTTPService:RequestAsync({
														Url = profileUrl,
														Method = "GET",
													})

													if response.Success then
														local responseData = HTTPService:JSONDecode(response.Body)
														local imageUrl = responseData.data[1].imageUrl

														local data = {
															["username"] = "Arrest - Player Arrested",
															["content"] = "",
															["embeds"] = {{
																["title"] = "**NEW Arrest**",
																["description"] = "**Arrestor: **"..player.Name.." ("..player.UserId..")".."\n\n".."**Target: **"..criminal.Name.." ("..criminal.UserId..")".."\n\n".."**Reason:** "..DEFAULT_ARREST_REASON.."\n\n".."**Time: **"..DEFAULT_ARREST_TIME,
																["type"] = "rich",
																["color"] = 0x3246a8,
																["thumbnail"] = {
																	["url"] = imageUrl
																}
															}}
														}

														HTTPService:PostAsync(ServerSettings.ArrestWebhook,
															HTTPService:JSONEncode(data)
														)
													end
												end

												-- Pulisci la connessione di arresto
												if ArrestConnections[player.Name] then
													ArrestConnections[player.Name][criminal.Name] = nil
												end

												-- Libera il target
												player.Character.TargetObject.Value = nil

												-- Notifica all'ufficiale che l'arresto è avvenuto con successo
												GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Hai arrestato " .. criminal.Name .. " con successo!")

												task.wait(1)

												criminal:LoadCharacter()

												task.wait(1)

												GlobalEvents.RemoteEvent:FireClient(criminal, "CuffPlayer", DEFAULT_ARREST_REASON, player.Name)

												break
											end
										end
									end
									break
								end
							end
						else
							GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi arrestare questo giocatore perché non l'hai ammanettato tu.")
						end
					else
						GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non hai un criminale da arrestare.")
					end
				else
					GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non hai un criminale da arrestare.")
				end
			end)
		end
	end
end

-- Importa il modulo WantedSystem
local WantedSystem = require(uxpRP.WantedSystem.Settings)
local WantedPlayers = {}
local DecayTimers = {}

-- Funzione per aggiornare l'UI
local function updatePlayerWantedUI(player)
	-- Implementazione dell'aggiornamento UI
end

uxpRP.GlobalEvents.RemoteEvent.OnServerEvent:Connect(function(player, EventType, Value1, Value2, Value3)
	if EventType == "Cuffing" then
		if checkPlayer(Value1) then
			for i, v in pairs(Settings.CanHandcuffPlayers) do
				if i == player.Team then
					for i1, v1 in pairs(v) do
						if i1 == Value1.Team then
							local Animation

							if Value1.Character.Humanoid.RigType == Enum.HumanoidRigType.R6 then
								Animation = Value1.Character.Humanoid:LoadAnimation(RPHandcuffs.Animations.R6.CuffedAnimation)
							elseif Value1.Character.Humanoid.RigType == Enum.HumanoidRigType.R15 then
								Animation = Value1.Character.Humanoid:LoadAnimation(RPHandcuffs.Animations.R15.CuffedAnimation)
							end

							if Value1.Character.CuffedValue.Value then
								-- Solo l'ufficiale che ha ammanettato il giocatore può liberarlo
								if not ArrestConnections[player.Name] or not ArrestConnections[player.Name][Value1.Name] then
									GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi liberare questo giocatore perché non l'hai ammanettato tu.")
									return
								end

								for _, v in pairs(Value1.Character.Humanoid:GetPlayingAnimationTracks()) do
									v:Stop()
								end

								Value1.Character.CuffedValue.Value = false

								Value1.Character.Humanoid.WalkSpeed = 16
								Value1.Character.Humanoid.JumpHeight = 7.2

								for i2, v2 in pairs(Value1.PlayerTools:GetChildren()) do
									if v2:IsA("Tool") then
										v2.Parent = Value1.Backpack
									end
								end

								player.Character.TargetObject.Value = nil

								-- Rimuovi dalle connessioni di arresto
								if ArrestConnections[player.Name] then
									ArrestConnections[player.Name][Value1.Name] = nil
								end

								-- Notifica al criminale che è stato rilasciato
								GlobalEvents.RemoteEvent:FireClient(Value1, "Notification", "Sei stato rilasciato.")

							else
								Animation:Play()

								Value1.Character.CuffedValue.Value = true

								Value1.Character.Humanoid.WalkSpeed = 8
								Value1.Character.Humanoid.JumpHeight = 3.6

								player.Character.TargetObject.Value = Value1

								for i2, v2 in pairs(Value1.Character:GetChildren()) do
									if v2:IsA("Tool") then
										v2.Parent = Value1.PlayerTools
									end
								end

								for i2, v2 in pairs(Value1.Backpack:GetChildren()) do
									if v2:IsA("Tool") then
										v2.Parent = Value1.PlayerTools
									end
								end

								-- Aggiungi alle connessioni di arresto
								if not ArrestConnections[player.Name] then
									ArrestConnections[player.Name] = {}
								end
								ArrestConnections[player.Name][Value1.Name] = true

								-- Notifica al criminale che è stato ammanettato
								GlobalEvents.RemoteEvent:FireClient(Value1, "Notification", "Sei stato ammanettato da " .. player.Name)
							end
							break
						end
					end
					break
				end
			end
		end

	elseif EventType == "Grabbing" then
		if checkPlayer(Value1) then
			for i, v in pairs(Settings.CanHandcuffPlayers) do
				if i == player.Team then
					for i1, v1 in pairs(v) do
						if i1 == Value1.Team then
							if v1.CanGrabPlayer then
								if Value1.Character.CuffedValue.Value then
									-- Solo l'ufficiale che ha ammanettato il giocatore può afferrarlo
									if not ArrestConnections[player.Name] or not ArrestConnections[player.Name][Value1.Name] then
										GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi afferrare questo giocatore perché non l'hai ammanettato tu.")
										return
									end

									if Value1.Character.GrabbedValue.Value then
										Value1.Character.GrabbedValue.Value = false
									else
										if (Value1.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude <= 8 then
											-- Se il criminale è seduto, rimuovilo dal sedile
											removeFromSeat(Value1)

											Value1.Character.Humanoid.PlatformStand = false
											Value1.Character.Humanoid.Sit = false
											Value1.Character.GrabbedValue.Value = true

											task.spawn(function()
												while Value1.Character.GrabbedValue.Value and Value1.Character.CuffedValue.Value do
													wait()
													Value1.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, -5)
												end
											end)
										end
									end
								end
							end
							break
						end
					end
					break
				end
			end
		end

	elseif EventType == "ItemRemoving" then
		if checkPlayer(player.Character.TargetObject.Value) then
			for i, v in pairs(Settings.CanHandcuffPlayers) do
				if i == player.Team then
					for i1, v1 in pairs(v) do
						if i1 == player.Character.TargetObject.Value.Team then
							if v1.CanRemovePlayerItems then
								-- Solo l'ufficiale che ha ammanettato il giocatore può rimuovere i suoi oggetti
								if not ArrestConnections[player.Name] or not ArrestConnections[player.Name][player.Character.TargetObject.Value.Name] then
									GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi rimuovere oggetti a questo giocatore perché non l'hai ammanettato tu.")
									return
								end

								player.Character.TargetObject.Value.PlayerTools:FindFirstChild(Value1):Destroy()
							end
							break
						end
					end
					break
				end
			end
		end

	elseif EventType == "Arrest" then
		if checkPlayer(player.Character.TargetObject.Value) then
			for i, v in pairs(Settings.CanHandcuffPlayers) do
				if i == player.Team then
					for i1, v1 in pairs(v) do
						if i1 == player.Character.TargetObject.Value.Team then
							if v1.CanArrestPlayer then
								-- Solo l'ufficiale che ha ammanettato il giocatore può arrestarlo
								if not ArrestConnections[player.Name] or not ArrestConnections[player.Name][player.Character.TargetObject.Value.Name] then
									GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi arrestare questo giocatore perché non l'hai ammanettato tu.")
									return
								end

								local criminal = player.Character.TargetObject.Value

								-- Verifica se il criminale è ricercato
								local wantedLevel = getPlayerWantedLevel(criminal)

								-- Controlla se il criminale è ricercato, altrimenti non permettere l'arresto
								if wantedLevel <= 0 then
									GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Non puoi arrestare questo giocatore perché non è ricercato.")
									return
								end

								-- Determina il tempo di arresto in base al livello di ricercato
								local arrestTime = getJailTimeFromWantedLevel(wantedLevel)

								-- Imposta una ragione personalizzata se il giocatore è ricercato
								local arrestReason = Value3 or DEFAULT_ARREST_REASON
								if wantedLevel > 0 and WantedPlayers[criminal.Name] and #WantedPlayers[criminal.Name].reason > 0 then
									arrestReason = "Ricercato (Stellette: " .. wantedLevel .. "): " .. table.concat(WantedPlayers[criminal.Name].reason, ", ")
								end

								if Value2 then
									if v1.CanSendPlayerToJail then
										local Profile = Manager.Profiles[player.Character.TargetObject.Value]

										Profile.Data.HandcuffsSystem.Reason = arrestReason
										Profile.Data.HandcuffsSystem.ArrestTime = arrestTime + os.time()
										Profile.Data.HandcuffsSystem.OfficerName = player.Name

										player.Character.TargetObject.Value.Team = v1.JailedTeam
										player.Character.TargetObject.Value.JailedValue.Value = arrestTime + os.time()

										player.Character.TargetObject.Value.Character.CuffedValue.Value = false
										player.Character.TargetObject.Value.Character.GrabbedValue.Value = false

										-- Dopo l'arresto, rimuovi lo stato di ricercato
										if wantedLevel > 0 then
											WantedPlayers[criminal.Name] = nil
											if DecayTimers[criminal.Name] then
												task.cancel(DecayTimers[criminal.Name])
												DecayTimers[criminal.Name] = nil
											end
											updatePlayerWantedUI(criminal)
										end

										for i6, v6 in pairs(player.Character.TargetObject.Value.PlayerTools:GetChildren()) do
											v6:Destroy()
										end

										GlobalEvents.RemoteEvent:FireClient(player.Character.TargetObject.Value, "CuffPlayer", arrestReason, player.Name)

										for i4, v4 in pairs(player.Character.TargetObject.Value.PlayerTools:GetChildren()) do
											v4:Destroy()
										end

										if ServerSettings.WebhookEnabled then
											local profileUrl = "https://thumbnails.roproxy.com/v1/users/avatar-bust?userIds=".. player.UserId .."&size=420x420&format=Png&isCircular=false"

											local response = HTTPService:RequestAsync({
												Url = profileUrl,
												Method = "GET",
											})

											if response.Success then
												local responseData = HTTPService:JSONDecode(response.Body)
												local imageUrl = responseData.data[1].imageUrl

												local TargetPlayer = player.Character.TargetObject.Value

												local data =
													{
														["username"] = "Arrest - Player Arrested",
														["content"] = "",
														["embeds"] = {{
															["title"] = "**NEW Arrest**",
															["description"] = "**Arrestor: **"..player.Name.." ("..player.UserId..")".."\n\n".."**Target: **"..TargetPlayer.Name.." ("..TargetPlayer.UserId..")".."\n\n".."**Reason:** "..arrestReason.."\n\n".."**Time: **"..arrestTime,
															["type"] = "rich",
															["color"] = 0x3246a8,
															["thumbnail"] = {
																["url"] = imageUrl
															}
														}}
													}

												HTTPService:PostAsync(ServerSettings.ArrestWebhook,
													HTTPService:JSONEncode(data)
												)
											end
										end

										-- Pulisci la connessione di arresto
										if ArrestConnections[player.Name] then
											ArrestConnections[player.Name][player.Character.TargetObject.Value.Name] = nil
										end

										-- Notifica all'ufficiale che l'arresto è avvenuto con successo
										GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Hai arrestato " .. player.Character.TargetObject.Value.Name .. " con successo!")

										task.wait(1)

										player.Character.TargetObject.Value:LoadCharacter()

										task.wait(1)

										GlobalEvents.RemoteEvent:FireClient(player.Character.TargetObject.Value, "CuffPlayer", arrestReason, player.Name)
									end

								else
									local Profile = Manager.Profiles[player.Character.TargetObject.Value]

									Profile.Data.HandcuffsSystem.Reason = arrestReason
									Profile.Data.HandcuffsSystem.ArrestTime = arrestTime + os.time()
									Profile.Data.HandcuffsSystem.OfficerName = player.Name

									player.Character.TargetObject.Value.JailedValue.Value = arrestTime + os.time()

									player.Character.TargetObject.Value.Character.CuffedValue.Value = false
									player.Character.TargetObject.Value.Character.GrabbedValue.Value = false

									task.wait(1)

									player.Character.TargetObject.Value.Character.Humanoid.WalkSpeed = 0
									player.Character.TargetObject.Value.Character.Humanoid.JumpHeight = 0

									if ServerSettings.WebhookEnabled then
										local profileUrl = "https://thumbnails.roproxy.com/v1/users/avatar-bust?userIds=".. player.UserId .."&size=420x420&format=Png&isCircular=false"

										local response = HTTPService:RequestAsync({
											Url = profileUrl,
											Method = "GET",
										})

										if response.Success then
											local responseData = HTTPService:JSONDecode(response.Body)
											local imageUrl = responseData.data[1].imageUrl

											local TargetPlayer = player.Character.TargetObject.Value

											local data =
												{
													["username"] = "Arrest - Player Arrested",
													["content"] = "",
													["embeds"] = {{
														["title"] = "**NEW Arrest**",
														["description"] = "**Arrestor: **"..player.Name.." ("..player.UserId..")".."\n\n".."**Target: **"..TargetPlayer.Name.." ("..TargetPlayer.UserId..")".."\n\n".."**Reason:** "..arrestReason.."\n\n".."**Time: **"..arrestTime,
														["type"] = "rich",
														["color"] = 0x3246a8,
														["thumbnail"] = {
															["url"] = imageUrl
														}
													}}
												}

											HTTPService:PostAsync(ServerSettings.ArrestWebhook,
												HTTPService:JSONEncode(data)
											)
										end
									end

									-- Pulisci la connessione di arresto
									if ArrestConnections[player.Name] then
										ArrestConnections[player.Name][player.Character.TargetObject.Value.Name] = nil
									end

									-- Notifica all'ufficiale che l'arresto è avvenuto con successo
									GlobalEvents.RemoteEvent:FireClient(player, "Notification", "Hai arrestato " .. player.Character.TargetObject.Value.Name .. " con successo!")

									GlobalEvents.RemoteEvent:FireClient(player.Character.TargetObject.Value, "CuffPlayer", arrestReason, player.Name)
								end
							end
							break
						end
					end
					break
				end
			end
		end

	elseif EventType == "UnArrest" then
		local Profile = Manager.Profiles[player]

		if Profile.Data.HandcuffsSystem.ArrestTime < os.time() then
			if player.Team == Settings.DefaultJailTeam then
				player.Team = Settings.DefaultUnJailTeam
			end

			task.wait(1)

			player:LoadCharacter()
		end
	end
end)

-- Monitora i nuovi sedili aggiunti al workspace
workspace.DescendantAdded:Connect(function(descendant)
	if descendant:IsA("Seat") or descendant:IsA("VehicleSeat") then
		createSeatPrompt(descendant)
	end
end)

-- Crea prompt nelle celle quando il gioco inizia
task.spawn(function()
	wait(5) -- Attendi che il gioco si carichi completamente
	createJailCellPrompts()

	-- Crea prompt su tutti i sedili esistenti
	for _, descendant in pairs(workspace:GetDescendants()) do
		if descendant:IsA("Seat") or descendant:IsA("VehicleSeat") then
			createSeatPrompt(descendant)
		end
	end
end)

-- Funzione per ottenere un ID univoco per un sedile
local function getSeatId(seat)
	return tostring(seat:GetFullName())
end

-- Funzione per ottenere il livello di ricercato di un giocatore
local function getPlayerWantedLevel(player)
	if WantedPlayers and WantedPlayers[player.Name] then
		return WantedPlayers[player.Name].level
	end
	return 0
end

-- Funzione per ottenere il tempo di arresto in base al livello di ricercato
local function getJailTimeFromWantedLevel(wantedLevel)
	local WantedSystem = require(uxpRP.WantedSystem.Settings)

	-- Arrotonda il livello di ricercato al mezzo punto più vicino
	local roundedLevel = math.floor(wantedLevel * 2) / 2

	-- Ottieni il tempo di arresto dalla tabella JailTimes
	local jailTime = WantedSystem.JailTimes[roundedLevel] or DEFAULT_ARREST_TIME

	return jailTime
end

Players.PlayerAdded:Connect(function(player)
	-- Inizializza la tabella delle connessioni di arresto per questo giocatore
	ArrestConnections[player.Name] = {}

	player.CharacterAdded:Connect(function(character)
		local CuffPrompt = Instance.new("ProximityPrompt")
		CuffPrompt.Name = "CuffPrompt"
		CuffPrompt.MaxActivationDistance = Settings.ActivationDistance
		CuffPrompt.RequiresLineOfSight = false
		CuffPrompt.Style = Enum.ProximityPromptStyle.Custom
		CuffPrompt.Parent = character.HumanoidRootPart

		CuffPrompt.KeyboardKeyCode = Settings.Keybind.Cuffing

		local CuffBoard = Untils.CuffBoard:Clone()
		CuffBoard.Parent = character.HumanoidRootPart

		local CuffedBoard = Untils.CuffedBoard:Clone()
		CuffedBoard.Parent = character.HumanoidRootPart

		local GrabbedBoard = Untils.GrabbedBoard:Clone()
		GrabbedBoard.Parent = character.HumanoidRootPart

		CuffBoard.Cuff.Button.Text = Settings.Keybind.CuffingText

		CuffedBoard.Grab.Button.Text = Settings.Keybind.GrabText
		CuffedBoard.UnCuff.Button.Text = Settings.Keybind.CuffingText

		GrabbedBoard.Arrest.Button.Text = Settings.Keybind.ArrestText
		GrabbedBoard.Search.Button.Text = Settings.Keybind.SearchText
		GrabbedBoard.UnGrab.Button.Text = Settings.Keybind.GrabText

		local CuffedValue = Instance.new("BoolValue")
		CuffedValue.Name = "CuffedValue"
		CuffedValue.Parent = character

		local GrabbedValue = Instance.new("BoolValue")
		GrabbedValue.Name = "GrabbedValue"
		GrabbedValue.Parent = character

		local TargetObject = Instance.new("ObjectValue")
		TargetObject.Name = "TargetObject"
		TargetObject.Parent = character

		local LocalTargetObject = Instance.new("ObjectValue")
		LocalTargetObject.Name = "LocalTargetObject"
		LocalTargetObject.Parent = character

		if player.Team == Settings.DefaultJailTeam then
			local Profile = Manager.Profiles[player]

			task.wait(3)

			GlobalEvents.RemoteEvent:FireClient(player, "CuffPlayer", Profile.Data.HandcuffsSystem.Reason, Profile.Data.HandcuffsSystem.OfficerName)
		end
	end)
end)
